<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>SSH | Luis Cacho</title>
    <link>/en/tags/ssh/</link>
      <atom:link href="/en/tags/ssh/index.xml" rel="self" type="application/rss+xml" />
    <description>SSH</description>
    <generator>Source Themes Academic (https://sourcethemes.com/academic/)</generator><language>en-us</language><copyright>Â© 2019</copyright><lastBuildDate>Tue, 31 Mar 2015 22:22:12 -0600</lastBuildDate>
    <image>
      <url>/img/lc-profile.png</url>
      <title>SSH</title>
      <link>/en/tags/ssh/</link>
    </image>
    
    <item>
      <title>SFTP Jailed</title>
      <link>/sftp-jailed/</link>
      <pubDate>Tue, 31 Mar 2015 22:22:12 -0600</pubDate>
      <guid>/sftp-jailed/</guid>
      <description>&lt;p&gt;To configure your server to use a jailed user on SFTP you should do:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Edit the sshd_config file
&lt;br /&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;We need to comment the following line:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;Subsystem sftp /usr/libexec/openssh/sftp-server
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And add the uncomment line, your modification will be same as:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;# Subsystem sftp /usr/libexec/openssh/sftp-server
Subsystem sftp internal-sftp
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Also, at the end of the file we should to add the next lines:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;Match Group sftponly
ChrootDirectory %h
X11Forwarding no
AllowTCPForwarding no
ForceCommand internal-sftp
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;After save all the changes, we must restart the sshd daemon&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;service sshd restart
&lt;/code&gt;&lt;/pre&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;Add &lt;strong&gt;sftponly&lt;/strong&gt; group&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;groupadd sftponly
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;Add jailed user and add to &lt;strong&gt;sftponly&lt;/strong&gt; group&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;useradd -m USERNAME
passwd USERNAME
usermod -aG sftponly,apache USERNAME
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;strong&gt;IMPORTANT&lt;/strong&gt;: Create directory and establish correct permissions&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;chown root:root /home/USERNAME
chmod 755 /home/USERNAME
mkdir /home/USERNAME/TEST.DOMAIN.COM
chown apache:apache /home/USERNAME/TEST.DOMAIN.COM
chmod 775 /home/USERNAME/TEST.DOMAIN.COM
mkdir /var/www/vhost/TEST.DOMAIN.COM
chown apache:apache /var/www/vhost/TEST.DOMAIN.COM
chmod 775 /var/www/vhost/TEST.DOMAIN.COM
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;em&gt;If you have any connection problem please double check the permissions on the folders and check the logs on /var/log/secure&lt;/em&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;tail -f /var/log/secure
&lt;/code&gt;&lt;/pre&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;Mount DocumentRoot path on jailed user home directory&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;mount -o bind,noatime /var/www/vhost/TEST.DOMAIN.COM/ /home/USERNAME/TEST.DOMAIN.COM
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;Make the mount point permanent, editing the fstab file:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;vi /etc/fstab&amp;lt;/pre&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Add the mount point at the end of the file:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;/var/www/vhost/TEST.DOMAIN.COM/ /home/USERNAME/TEST.DOMAIN.COM none bind,noatime 0 0
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Save and exit&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;Test connection:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;sftp SERVERIP
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;/ol&gt;
</description>
    </item>
    
  </channel>
</rss>
